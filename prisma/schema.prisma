// pagerefresh.ai MVP - Database Schema
// See MVP-PLAN.md for full specification

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Refresh {
  id                String   @id @default(cuid())
  url               String
  targetWebsite     String
  screenshotUrl     String?
  htmlSnapshot      String   @db.Text
  cssSnapshot       String   @db.Text

  // Extracted Assets
  extractedColors   Json     // Array of hex codes with names
  extractedFonts    Json     // Array of font families
  extractedImages   Json     // Array of image URLs + descriptions
  extractedCopy     Json     // Hero text, headlines, body samples
  extractedLogo     String?

  // AI Analysis Results
  brandAnalysis     String   @db.Text // Claude Vision output
  industryDetected  String   // Detected industry name
  industryConfidence Float   // 0-1 confidence score

  // 0-100 Scoring System (8 Dimensions)
  overallScore      Int      // Weighted average 0-100
  clarityScore      Int      // Dimension 1
  visualScore       Int      // Dimension 2
  hierarchyScore    Int      // Dimension 3
  trustScore        Int      // Dimension 4
  conversionScore   Int      // Dimension 5
  contentScore      Int      // Dimension 6
  mobileScore       Int      // Dimension 7
  performanceScore  Int      // Dimension 8

  // Dimension Details (JSON with issues/recommendations per dimension)
  scoringDetails    Json     // Array of {dimension, score, issues[], recommendations[]}

  // Basic SEO Audit
  seoAudit          Json     // {title, metaDescription, headings, issues[]}

  // Generated Layouts
  layout1Html       String   @db.Text
  layout1Css        String   @db.Text
  layout1Template   String   // Template name used
  layout1CopyRefreshed String @db.Text // AI-refreshed copy version

  layout2Html       String   @db.Text
  layout2Css        String   @db.Text
  layout2Template   String
  layout2CopyRefreshed String @db.Text

  layout3Html       String   @db.Text
  layout3Css        String   @db.Text
  layout3Template   String
  layout3CopyRefreshed String @db.Text

  // Lead Capture
  selectedLayout    Int?     // 1-3 (if user selected one)
  quoteRequested    Boolean  @default(false)
  installRequested  Boolean  @default(false)
  contactEmail      String?
  contactPhone      String?
  hostingPlatform   String?  // For install request
  notes             String?  @db.Text

  // Pipeline status
  status            String   @default("pending")  // pending | fetching | analyzing | scoring | generating | complete | failed
  errorMessage      String?  @db.Text  // Last error message from pipeline
  errorStep         String?             // Which step failed: preflight | fetching | analyzing | scoring | generating

  // Metadata
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
  processingTime    Int?     // Total time in seconds

  // Access: token required to view results (link-level, not guessable)
  viewToken         String   @unique @default(cuid())

  // URL Profile link (Phase 2 sets this at pipeline start)
  urlProfileId      String?
  urlProfile        UrlProfile? @relation(fields: [urlProfileId], references: [id])

  // Audit: which AgentSkill.version was used per agent at runtime
  skillVersions     Json?

  // Benchmark comparison (Phase 4 populates this)
  benchmarkComparison Json?

  // Layout rationale from Creative Agents (Phase 2 writes, Phase 4 enriches)
  layout1Rationale  String   @db.Text @default("")
  layout2Rationale  String   @db.Text @default("")
  layout3Rationale  String   @db.Text @default("")

  // Relationships
  promptHistory     PromptLog[]
  internalNotes     InternalNote[]

  @@index([url])
  @@index([industryDetected])
  @@index([createdAt])
  @@index([quoteRequested])
  @@index([installRequested])
  @@index([urlProfileId])
  @@index([status])
}

model Industry {
  id                String   @id @default(cuid())
  name              String   @unique
  description       String   @db.Text

  // Universal dimensions scoring criteria (JSON)
  scoringCriteria   Json     // Array of criteria per dimension

  // Template preferences
  preferredTemplates Json    // Array of template IDs suitable for this industry

  exampleWebsites   Json?    // Reference sites
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  @@index([name])
}

model Template {
  id                String   @id @default(cuid())
  name              String   @unique
  description       String   @db.Text
  htmlTemplate      String   @db.Text
  cssTemplate       String   @db.Text
  previewImageUrl   String?

  // Template metadata
  category          String   // 'hero', 'features', 'testimonials', etc.
  suitableIndustries Json    // Array of industry names

  // Performance tracking
  usageCount        Int      @default(0)
  conversionRate    Float?   // Future: track if users select this template

  // Platform compatibility
  supportsSquarespace Boolean @default(true)
  supportsWordPress   Boolean @default(true)
  supportsWix         Boolean @default(true)

  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  @@index([category])
}

model PromptLog {
  id                String   @id @default(cuid())
  refreshId         String
  refresh           Refresh  @relation(fields: [refreshId], references: [id], onDelete: Cascade)

  step              String   // 'screenshot_analysis' | 'industry_detection' | 'dimension_scoring' | etc.
  provider          String   // 'claude' | 'openai'
  model             String   // 'claude-3-5-sonnet-20241022' | 'gpt-4' | etc.

  promptText        String   @db.Text
  responseText      String   @db.Text

  tokensUsed        Int?
  responseTime      Int?     // milliseconds

  createdAt         DateTime @default(now())

  @@index([refreshId])
  @@index([step])
}

model InternalNote {
  id          String   @id @default(cuid())
  refreshId   String
  refresh     Refresh  @relation(fields: [refreshId], references: [id], onDelete: Cascade)

  authorName  String   // Team member name
  content     String   @db.Text
  category    String?  // e.g., 'review', 'sales', 'quality', 'follow-up'

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([refreshId])
}

model ScoringRubric {
  id                String   @id @default(cuid())
  dimension         String   // 'clarity' | 'visual' | 'hierarchy' | etc.
  scoreRange        String   // '0-20' | '21-40' | '41-60' | '61-80' | '81-100'

  // Scoring criteria for this range
  criteria          Json     // {indicators: [], antipatterns: []}

  exampleSites      Json?    // Reference examples

  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  @@index([dimension])
  @@index([scoreRange])
}

// --- Phase 1 Foundation Models ---

model UrlProfile {
  id              String    @id @default(cuid())
  url             String    @unique
  domain          String
  industry        String?
  industryLocked  Boolean   @default(false)

  brandAssets     Json?
  extractedCopy   Json?
  techStack       Json?

  analysisCount   Int       @default(0)
  lastAnalyzedAt  DateTime?
  bestScore       Int?
  latestScore     Int?

  customerEmail   String?
  customerId      String?

  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  expiresAt       DateTime?

  analyses        Refresh[]
  assets          UrlAsset[]

  @@index([domain])
  @@index([industry])
  @@index([customerEmail])
  @@index([expiresAt])
}

model UrlAsset {
  id            String     @id @default(cuid())
  urlProfileId  String
  urlProfile    UrlProfile @relation(fields: [urlProfileId], references: [id], onDelete: Cascade)

  assetType     String
  fileName      String
  mimeType      String
  fileSize      Int?
  storageKey    String
  storageUrl   String?

  metadata      Json?
  sourceUrl     String?
  extractedAt   DateTime   @default(now())

  @@index([urlProfileId])
  @@index([urlProfileId, assetType])
}

model AgentSkill {
  id                  String    @id @default(cuid())
  agentSlug           String    @unique
  agentName           String
  category            String
  systemPrompt        String    @db.Text
  outputSchema        Json?
  modelOverride       String?
  maxTokens           Int?
  temperature         Float?
  active              Boolean   @default(true)
  version             Int       @default(1)
  lastEditedBy        String?
  createdAt           DateTime  @default(now())
  updatedAt           DateTime  @updatedAt

  history             AgentSkillHistory[]

  @@index([agentSlug])
  @@index([category])
}

model AgentSkillHistory {
  id            String    @id @default(cuid())
  agentSkillId  String
  agentSkill    AgentSkill @relation(fields: [agentSkillId], references: [id], onDelete: Cascade)
  agentSlug     String
  systemPrompt  String    @db.Text
  version       Int
  editedBy      String?
  changeNote    String?   @db.Text
  createdAt     DateTime  @default(now())

  @@index([agentSkillId])
  @@index([agentSlug, version])
}

model ApiConfig {
  id            String    @id @default(cuid())
  provider      String
  configKey     String
  configValue   String    @db.Text
  encrypted     Boolean   @default(false)
  label         String?
  active        Boolean   @default(true)
  sortOrder     Int       @default(0)
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  @@unique([provider, configKey, label])
  @@index([provider])
  @@index([provider, configKey, active])
}

model Benchmark {
  id               String    @id @default(cuid())
  url              String
  domain           String?
  siteName         String?
  industry         String
  screenshotUrl    String?
  overallScore     Int       @default(0)
  clarityScore     Int       @default(0)
  visualScore      Int       @default(0)
  hierarchyScore   Int       @default(0)
  trustScore       Int       @default(0)
  conversionScore  Int       @default(0)
  contentScore     Int       @default(0)
  mobileScore      Int       @default(0)
  performanceScore Int       @default(0)
  scoringDetails   Json      @default("[]")
  scored           Boolean   @default(false)
  scoredAt         DateTime?
  active           Boolean   @default(true)
  notes            BenchmarkNote[]
  createdAt        DateTime  @default(now())
  updatedAt        DateTime  @updatedAt

  @@index([industry])
  @@index([industry, scored])
  @@index([industry, active])
  @@index([industry, overallScore])
}

model BenchmarkNote {
  id          String    @id @default(cuid())
  benchmarkId String
  benchmark   Benchmark @relation(fields: [benchmarkId], references: [id], onDelete: Cascade)
  authorName  String
  content     String    @db.Text
  category    String?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  @@index([benchmarkId])
}
